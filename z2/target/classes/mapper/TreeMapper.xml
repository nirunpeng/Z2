<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.com_jc_tree.dao.TreeMapper">
    <select id="getTreeByUserId" parameterType="Integer" resultMap = "getTreeByUserIdMap">
    select t.* ,u.id as u_id ,u.name as u_name ,u.age,u.date,u.open_id from tree t, user u
    where   t.user_id= u.id and u.id=#{id}
    </select>
    <resultMap id="getTreeByUserIdMap" type="Tree">
        <id property="id" column="id"/>
        <result property="name" column="tree_name"/>
        <result property="life" column="life"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="time" column="time"/>

        <association property="user" javaType="User">
            <id property="id" column="u_id"/>
            <result property="name" column="u_name"/>
            <result property="password" column="password"/>
            <result property="age" column="age"/>
            <result property="date" column="date"/>
            <result property="open_id" column="openId"/>
            <result property="session_id" column="sessionId"/>
            <result property="session_key" column="sessionKey"/>

        </association>
    </resultMap>

    <insert id="plantTree" parameterType="com.example.com_jc_tree.model.TreeMod">
        insert into tree(tree_name, user_id, life,  longitude, latitude, time)
        values(#{name}, #{userId}, #{life}, #{longitude}, #{latitude}, #{time})
    </insert>

<!--    更新树life-->
    <update id="updateLife">
        update tree set life = life + #{water} where id = #{treeId}
    </update>

    <select id="getTreeBySessionId" parameterType="String" resultMap="getTreeBySessionIdMap">
        select t.*, u.id as u_id, u.session_id, u.open_id
        from user u, tree t
        where t.user_id = u.id and u.session_id = #{sessionId}
    </select>
    <resultMap id="getTreeBySessionIdMap" type="com.example.com_jc_tree.entity.Tree">
        <id property="id" column="id"/>
        <result property="name" column="tree_name"/>
        <result property="life" column="life"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="time" column="time"/>

        <association property="user" javaType="com.example.com_jc_tree.entity.User">
            <id property="id" column="u_id"/>
            <result property="name" column="u_name"/>
            <result property="password" column="password"/>
            <result property="age" column="age"/>
            <result property="date" column="date"/>
            <result property="open_id" column="openId"/>
            <result property="session_id" column="sessionId"/>
            <result property="session_key" column="sessionKey"/>

        </association>
    </resultMap>

    <select id="getTreeByDistance" resultMap="getTreeBySessionIdMap">
        select *,u.id as u_id, u.open_id from tree t, user u
        where t.user_id = u.id and
            (t.latitude between (#{l1}-0.01) and (#{l1}+0.01)) and
            (t.longitude between (#{l2}-0.01) and (#{l2}+0.01) )
    </select>
</mapper>
